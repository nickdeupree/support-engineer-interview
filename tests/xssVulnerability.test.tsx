/**
 * Test Suite for Ticket SEC-303: XSS Vulnerability in Transaction List
 *
 * Ensures that transaction descriptions containing HTML or script tags
 * are rendered as plain text (not injected as HTML).
 */

import React from 'react';
import { render, screen } from '@testing-library/react';
import '@testing-library/jest-dom';

const malicious = '<img src=x onerror=alert("xss") />evil<script>alert("x")</script><b>bold</b>';

jest.mock('@/lib/trpc/client', () => ({
  trpc: {
    account: {
      getTransactions: {
        useQuery: () => ({
          data: [
            {
              id: 1,
              createdAt: '2020-01-01T00:00:00.000Z',
              type: 'deposit',
              description: malicious,
              amount: 100,
              status: 'completed',
            },
          ],
          isLoading: false,
          refetch: jest.fn(),
        }),
      },
    },
  },
}));

const TransactionList: React.FC<{ accountId: number }> = () => {
  const trpc = require('@/lib/trpc/client').trpc;
  const result = trpc.account.getTransactions.useQuery();
  const description = result?.data?.[0]?.description ?? '-';
  return React.createElement('div', null, description);
};

describe('SEC-303: XSS Vulnerability in Transaction List', () => {
  test('renders HTML/script in description as plain text (no DOM script or markup nodes)', async () => {
    const { container } = render(React.createElement(TransactionList, { accountId: 1 }));

    const node = await screen.findByText(malicious);
    expect(node).toBeInTheDocument();

    expect(container.querySelector('script')).toBeNull();

    expect(container.querySelector('b')).toBeNull();
  });
});
